import requests
from requests.auth import HTTPBasicAuth
import urllib3
import json
import os
import re
from datetime import datetime
import chardet

# ç¦ç”¨SSLè­¦å‘Š
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# æ—¥å¿—ç›®å½•è·¯å¾„
LOG_DIR = r"D:\WeGameApps\è‹±é›„è”ç›Ÿ\LeagueClient"

def get_latest_log_file():
    """è·å–æœ€æ–°çš„æ—¥å¿—æ–‡ä»¶"""
    try:
        # åˆ—å‡ºæ‰€æœ‰æ—¥å¿—æ–‡ä»¶
        log_files = [f for f in os.listdir(LOG_DIR) 
                    if f.endswith("_LeagueClientUx.log") and "T" in f]
        
        if not log_files:
            print("âš ï¸ æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œè¯·ç¡®ä¿æ¸¸æˆå®¢æˆ·ç«¯å·²è¿è¡Œ")
            return None
        
        # æå–æ–‡ä»¶åä¸­çš„æ—¶é—´æˆ³å¹¶æ’åº
        def extract_time(f):
            try:
                # æ–‡ä»¶åæ ¼å¼: 2025-07-12T12-23-05_18520_LeagueClientUx.log
                time_str = f.split("T")[0] + "T" + f.split("T")[1].split("_")[0]
                return datetime.strptime(time_str, "%Y-%m-%dT%H-%M-%S")
            except:
                return datetime.min
        
        # è·å–æœ€æ–°æ–‡ä»¶
        latest_file = max(log_files, key=extract_time)
        return os.path.join(LOG_DIR, latest_file)
    
    except Exception as e:
        print(f"è·å–æ—¥å¿—æ–‡ä»¶æ—¶å‡ºé”™: {e}")
        return None

def detect_file_encoding(file_path):
    """æ£€æµ‹æ–‡ä»¶ç¼–ç """
    try:
        # è¯»å–æ–‡ä»¶å¼€å¤´éƒ¨åˆ†å†…å®¹æ£€æµ‹ç¼–ç 
        with open(file_path, 'rb') as f:
            raw_data = f.read(4096)
            result = chardet.detect(raw_data)
            return result['encoding'] or 'gbk'
    except Exception as e:
        print(f"æ£€æµ‹æ–‡ä»¶ç¼–ç å¤±è´¥: {e}, é»˜è®¤ä½¿ç”¨GBK")
        return 'gbk'

def extract_params_from_log(log_file):
    """ä»æ—¥å¿—æ–‡ä»¶ä¸­æå–è®¤è¯ä»¤ç‰Œå’Œç«¯å£å·"""
    try:
        # æ£€æµ‹æ–‡ä»¶ç¼–ç 
        encoding = detect_file_encoding(log_file)
        print(f"æ£€æµ‹åˆ°æ–‡ä»¶ç¼–ç : {encoding}")
        
        with open(log_file, "r", encoding=encoding, errors='replace') as f:
            # è¯»å–å‰7è¡Œï¼ˆç¬¬7è¡ŒåŒ…å«å‚æ•°ï¼‰
            for i in range(7):
                line = f.readline().strip()
                if i == 6:  # ç¬¬7è¡Œ
                    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å‚æ•°
                    token_match = re.search(r"--remoting-auth-token=([\w-]+)", line)
                    port_match = re.search(r"--app-port=(\d+)", line)
                    
                    if token_match and port_match:
                        return token_match.group(1), int(port_match.group(1))
                    else:
                        print(f"âš ï¸ å‚æ•°æå–å¤±è´¥ï¼Œç¬¬7è¡Œå†…å®¹: {line[:100]}...")
        return None, None
    except Exception as e:
        print(f"è¯»å–æ—¥å¿—æ–‡ä»¶æ—¶å‡ºé”™: {e}")
        return None, None

def get_puuid(auth_token, app_port, summoner_name):
    """è·å–å¬å”¤å¸ˆçš„PUUID"""
    url = f"https://riot:{auth_token}@127.0.0.1:{app_port}/lol-summoner/v1/summoners"
    try:
        response = requests.get(
            url,
            params={'name': summoner_name},
            auth=HTTPBasicAuth('riot', auth_token),
            verify=False,
            timeout=10
        )
        
        if response.status_code == 200:
            data = response.json()
            return data.get('puuid')
        else:
            print(f"è·å–PUUIDå¤±è´¥! çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”å†…å®¹: {response.text}")
            return None
            
    except requests.exceptions.RequestException as e:
        print(f"è¯·æ±‚å¼‚å¸¸: {e}")
        return None

def get_match_history(auth_token, app_port, puuid):
    """è·å–æ¯”èµ›å†å²è®°å½•"""
    url = f"https://riot:{auth_token}@127.0.0.1:{app_port}/lol-match-history/v1/products/lol/{puuid}/matches"
    try:
        response = requests.get(
            url,
            auth=HTTPBasicAuth('riot', auth_token),
            verify=False,
            timeout=10
        )
        
        if response.status_code == 200:
            return response.json()
        else:
            print(f"è·å–æ¯”èµ›è®°å½•å¤±è´¥! çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”å†…å®¹: {response.text}")
            return None
            
    except requests.exceptions.RequestException as e:
        print(f"è¯·æ±‚å¼‚å¸¸: {e}")
        return None

def main():
    print("="*50)
    print("è‹±é›„è”ç›Ÿæ¯”èµ›è®°å½•è·å–å·¥å…·")
    print("="*50)
    
    # è‡ªåŠ¨è·å–è®¤è¯ä»¤ç‰Œå’Œç«¯å£å·
    auth_token, app_port = None, None
    log_file = get_latest_log_file()
    
    if log_file:
        print(f"æ‰¾åˆ°æœ€æ–°æ—¥å¿—æ–‡ä»¶: {log_file}")
        auth_token, app_port = extract_params_from_log(log_file)
    
    if auth_token and app_port:
        print(f"âœ… è‡ªåŠ¨è·å–è®¤è¯ä»¤ç‰Œå’Œç«¯å£å·æˆåŠŸ!")
        print(f"è®¤è¯ä»¤ç‰Œ: {auth_token}")
        print(f"åº”ç”¨ç«¯å£: {app_port}")
    else:
        print("âš ï¸ è‡ªåŠ¨è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥")
        auth_token = input("è¯·è¾“å…¥è®¤è¯ä»¤ç‰Œ(auth_token): ").strip()
        app_port = input("è¯·è¾“å…¥åº”ç”¨ç«¯å£å·(app_port): ").strip()
        try:
            app_port = int(app_port)
        except ValueError:
            print("âŒ ç«¯å£å·å¿…é¡»æ˜¯æ•°å­—")
            return
    
    summoner_name = input("\nè¯·è¾“å…¥å¬å”¤å¸ˆåç§°: ").strip()
    
    if not summoner_name:
        print("âŒ å¬å”¤å¸ˆåç§°ä¸èƒ½ä¸ºç©º")
        return
    
    # è·å–PUUID
    print("\næ­£åœ¨è·å–PUUID...")
    puuid = get_puuid(auth_token, app_port, summoner_name)
    
    if not puuid:
        print("âŒ æ— æ³•è·å–PUUIDï¼Œè¯·æ£€æŸ¥è¾“å…¥å¹¶é‡è¯•")
        return
    
    print(f"âœ… æˆåŠŸè·å–PUUID: {puuid}")
    
    # è·å–æ¯”èµ›è®°å½•
    print("\næ­£åœ¨è·å–æ¯”èµ›è®°å½•...")
    match_history = get_match_history(auth_token, app_port, puuid)
    
    if match_history:
        print("\nğŸ® æ¯”èµ›è®°å½•è·å–æˆåŠŸ!")
        print("="*50)
        
        # ç¾åŒ–è¾“å‡ºæ¯”èµ›è®°å½•
       #total_count = match_history.get('totalCount', 0)
        #print(f"æ€»æ¯”èµ›åœºæ¬¡: {total_count}")
        
        #if total_count == 0:
         #   print("æ²¡æœ‰æ‰¾åˆ°æ¯”èµ›è®°å½•")
         #   return
        
        print("æœ€è¿‘5åœºæ¯”èµ›:")
        
        # æå–æœ€è¿‘çš„5åœºæ¯”èµ›
        games = match_history.get('games', {}).get('games', [])[:5]
        for i, game in enumerate(games, 1):
            print(f"\næ¯”èµ› #{i}:")
            print(f"æ¨¡å¼: {game.get('gameMode', 'æœªçŸ¥æ¨¡å¼')}")
            print(f"ç±»å‹: {game.get('gameType', 'æœªçŸ¥ç±»å‹')}")
            print(f"å¼€å§‹æ—¶é—´: {game.get('gameCreationDate', 'æœªçŸ¥æ—¶é—´')}")
            
            duration = game.get('gameDuration', 0)
            minutes, seconds = divmod(duration, 60)
            print(f"æŒç»­æ—¶é—´: {minutes}åˆ†{seconds}ç§’")
            
            # æŸ¥æ‰¾ç©å®¶æ•°æ®
            for participant in game.get('participants', []):
                #if participant.get('puuid') == puuid:
                    stats = participant.get('stats', {})
                    print(f"è‹±é›„ID: {participant.get('championId')}")
                    print(f"å‡»æ€/æ­»äº¡/åŠ©æ”»: {stats.get('kills', 0)}/{stats.get('deaths', 0)}/{stats.get('assists', 0)}")
                    print(f"æ˜¯å¦èƒœåˆ©: {'èƒœåˆ©' if stats.get('win', False) else 'å¤±è´¥'}")
                    break
        
        print("\nå®Œæ•´æ•°æ®å·²ä¿å­˜åˆ° match_history.json")
        
        # ä¿å­˜å®Œæ•´æ•°æ®åˆ°æ–‡ä»¶
        try:
            with open('match_history.json', 'w', encoding='utf-8') as f:
                json.dump(match_history, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
    else:
        print("âŒ æ— æ³•è·å–æ¯”èµ›è®°å½•")

if __name__ == "__main__":
    main()