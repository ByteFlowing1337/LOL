<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ summoner_name }} - è¯¦ç»†æˆ˜ç»©</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    
    <style>
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .game-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 1rem;
        }
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .win-bg { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
        .loss-bg { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); }
        .item-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin: 2px;
        }
        .augment-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid #764ba2;
            margin: 0 2px;
            box-shadow: 0 2px 4px rgba(118, 75, 162, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1px;
        }
        .augments-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        .champion-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
            .champion-wrapper { position: relative; display: inline-block; }
            .level-badge { position: absolute; right: -6px; bottom: -6px; background: rgba(0,0,0,0.75); color: #fff; width: 28px; height: 28px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:0.85rem; border:2px solid #fff; }
            .kda-badge { background: linear-gradient(90deg,#ffecb3,#ffd54f); padding:6px 10px; border-radius:8px; font-weight:700; color:#222; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
            .items-col { display:flex; gap:4px; align-items:center; }
            .meta-badge { font-size:0.85rem; padding:0.25rem 0.5rem; margin-right:6px; }
        .stats-badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            margin: 0.2rem;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .bg-light-success {
            background-color: #d4edda !important;
        }
        .subteam-card {
            transition: all 0.2s ease;
        }
        .subteam-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        /* KIWI æ¨¡å¼ç´«è‰²å¾½ç«  */
        .bg-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
    </style>
</head>
<body>

<a href="/" class="btn btn-primary back-button">
    <i class="bi bi-arrow-left me-2"></i>è¿”å›ä¸»é¡µ
</a>

<div class="container">
    <header class="text-center mb-5">
        <h1 class="display-5 fw-bold text-dark">
            <i class="bi bi-person-circle me-2 text-primary"></i>{{ summoner_name }}
        </h1>
        <p class="lead text-muted">è¯¦ç»†å†å²æˆ˜ç»©</p>
    </header>

    <div id="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <p class="mt-3 text-muted">æ­£åœ¨åŠ è½½æˆ˜ç»©æ•°æ®...</p>
    </div>

    <div id="stats-summary" class="row mb-4" style="display: none;">
        <!-- ç»Ÿè®¡æ‘˜è¦å°†ç”±JavaScriptå¡«å…… -->
    </div>

    <div id="games-container">
        <!-- æ¸¸æˆåˆ—è¡¨å°†ç”±JavaScriptå¡«å…… -->
    </div>

    <div id="error-message" class="alert alert-danger d-none" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="error-text"></span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Server-provided data (JSON) to avoid embedding raw Jinja in JS code that breaks editor linting -->
<script id="server-data" type="application/json">{{ {'summoner_name': summoner_name, 'puuid': (puuid if puuid is defined else ''), 'champion_map': (champion_map if champion_map is defined else {}) }|tojson }}</script>
<script>
    const SERVER_DATA = JSON.parse(document.getElementById('server-data').textContent || '{}');
    const summonerName = SERVER_DATA.summoner_name || '';
    const summonerPuuid = SERVER_DATA.puuid || '';
    const CHAMPION_MAP = SERVER_DATA.champion_map || {};
    
    // Small helper for compact number formatting: 14300 -> 14.3k
    function fmt(n){
        if (n === null || n === undefined) return '';
        if (Math.abs(n) >= 1000) return (n/1000).toFixed(1).replace(/\.0$/,'')+'k';
        return ''+n;
    }

    async function loadSummonerDetails() {
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const gamesContainer = document.getElementById('games-container');
        const summaryDiv = document.getElementById('stats-summary');

        try {
            let historyUrl = '';
            if (summonerPuuid && summonerPuuid.length > 0) {
                historyUrl = `/get_history?puuid=${encodeURIComponent(summonerPuuid)}`;
            } else {
                historyUrl = `/get_history?name=${encodeURIComponent(summonerName)}`;
            }
            const response = await fetch(historyUrl);
            const data = await response.json();

            loadingDiv.style.display = 'none';

            if (!data.success || !data.games || data.games.length === 0) {
                errorDiv.classList.remove('d-none');
                errorText.textContent = data.message || 'æœªæ‰¾åˆ°æˆ˜ç»©æ•°æ®';
                return;
            }

            // æ˜¾ç¤ºç»Ÿè®¡æ‘˜è¦
            displayStatsSummary(data.games, summaryDiv);
            
            // æ˜¾ç¤ºæ¸¸æˆåˆ—è¡¨
            displayGames(data.games, gamesContainer);

        } catch (error) {
            console.error('åŠ è½½æˆ˜ç»©å¤±è´¥:', error);
            loadingDiv.style.display = 'none';
            errorDiv.classList.remove('d-none');
            errorText.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        }
    }

    function displayStatsSummary(games, container) {
        const totalGames = games.length;
        const wins = games.filter(g => g.win).length;
        const losses = totalGames - wins;
        const winRate = ((wins / totalGames) * 100).toFixed(1);

        let totalKills = 0, totalDeaths = 0, totalAssists = 0;
        games.forEach(game => {
            const [k, d, a] = game.kda.split('/').map(Number);
            totalKills += k;
            totalDeaths += d;
            totalAssists += a;
        });

        const avgKills = (totalKills / totalGames).toFixed(1);
        const avgDeaths = (totalDeaths / totalGames).toFixed(1);
        const avgAssists = (totalAssists / totalGames).toFixed(1);
        const kdaRatio = totalDeaths > 0 ? ((totalKills + totalAssists) / totalDeaths).toFixed(2) : 'Perfect';

        container.innerHTML = `
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">æ€»åœºæ¬¡</h6>
                        <h3 class="mb-0">${totalGames}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">èƒœç‡</h6>
                        <h3 class="mb-0 ${winRate >= 50 ? 'text-success' : 'text-danger'}">${winRate}%</h3>
                        <small class="text-muted">${wins}èƒœ ${losses}è´¥</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">å¹³å‡KDA</h6>
                        <h3 class="mb-0 text-info">${kdaRatio}</h3>
                        <small class="text-muted">${avgKills} / ${avgDeaths} / ${avgAssists}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">æœ€å¸¸ä½¿ç”¨</h6>
                        <h5 class="mb-0">${getMostPlayedChampion(games)}</h5>
                    </div>
                </div>
            </div>
        `;
        container.style.display = 'flex';
    }

    function getMostPlayedChampion(games) {
        const champCount = {};
        games.forEach(game => {
            champCount[game.champion_en] = (champCount[game.champion_en] || 0) + 1;
        });
        const mostPlayed = Object.entries(champCount).sort((a, b) => b[1] - a[1])[0];
        return mostPlayed ? `${mostPlayed[0]} (${mostPlayed[1]}åœº)` : 'N/A';
    }

    // æ¸¸æˆæ¨¡å¼åç§°æ˜ å°„
    function getModeName(mode) {
        const modeMap = {
            'CLASSIC': 'ç»å…¸æ¨¡å¼',
            'ARAM': 'æåœ°å¤§ä¹±æ–—',
            'KIWI': 'æµ·å…‹æ–¯å¤§ä¹±æ–—',
            'CHERRY': 'æ–—é­‚ç«æŠ€åœº',
            'URF': 'æ— é™ç«åŠ›',
            'ONEFORALL': 'å…‹éš†æ¨¡å¼',
            'NEXUSBLITZ': 'æ¿€æ–—å³¡è°·',
            'TUTORIAL': 'æ•™ç¨‹',
            'PRACTICETOOL': 'è®­ç»ƒæ¨¡å¼'
        };
        return modeMap[mode] || mode;
    }

    function displayGames(games, container) {
        // keep games globally so toggleMatchDetails can access them
        window._games = games;

        container.innerHTML = games.map((game, index) => {
            const isCherryMode = game.mode === 'CHERRY' || game.gameMode === 'CHERRY';
            
            // CHERRY æ¨¡å¼ï¼šä½¿ç”¨æ’ååˆ¤æ–­èƒœè´Ÿ
            let winClass, winText, winIcon;
            if (isCherryMode) {
                const placement = game.subteamPlacement || 0;
                const isTop4 = placement > 0 && placement <= 4;
                winClass = isTop4 ? 'win-bg' : 'loss-bg';
                
                const rankEmoji = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£'][placement - 1] || `#${placement}`;
                winText = isTop4 ? `${rankEmoji} ç¬¬${placement}å` : `${rankEmoji} ç¬¬${placement}å`;
                winIcon = isTop4 ? 'trophy-fill text-success' : 'x-circle-fill text-danger';
            } else {
                // æ™®é€šæ¨¡å¼
                winClass = game.win ? 'win-bg' : 'loss-bg';
                winText = game.win ? 'èƒœåˆ©' : 'å¤±è´¥';
                winIcon = game.win ? 'trophy-fill text-success' : 'x-circle-fill text-danger';
            }
            
            const [kills, deaths, assists] = game.kda.split('/');
            const kda = deaths > 0 ? ((parseInt(kills) + parseInt(assists)) / parseInt(deaths)).toFixed(2) : 'Perfect';
            
            // OP.GG integration removed: no external badges

            return `
                <div class="card game-card ${winClass}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- å·¦ä¾§ï¼šè‹±é›„ä¿¡æ¯ -->
                            <div class="col-md-2 col-sm-3 text-center">
                                <img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/champion/${game.champion_en}.png" 
                                     alt="${game.champion_en}" 
                                     class="champion-icon mb-2">
                                <h6 class="mb-0">${game.champion_en}</h6>
                                
                            </div>

                            <!-- ä¸­é—´ï¼šæˆ˜ç»©æ•°æ® -->
                            <div class="col-md-6 col-sm-5">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-${winIcon} me-2 fs-5"></i>
                                    <h5 class="mb-0 fw-bold">${winText}</h5>
                                    <span class="badge ${isCherryMode ? 'bg-info' : ((game.gameMode === 'KIWI' || game.mode === 'KIWI') ? 'bg-purple' : 'bg-secondary')} ms-2">
                                        ${getModeName(game.gameMode || game.mode)}
                                    </span>
                                </div>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge stats-badge bg-dark">
                                        <i class="bi bi-diagram-3 me-1"></i>
                                        KDA: ${game.kda}
                                    </span>
                                    <span class="badge stats-badge ${kda >= 3 ? 'bg-success' : kda >= 2 ? 'bg-info' : 'bg-warning'}">
                                        <i class="bi bi-star-fill me-1"></i>
                                        æ¯”å€¼: ${kda}
                                    </span>
                                    <span class="badge stats-badge bg-primary">
                                        <i class="bi bi-coin me-1"></i>
                                        ${game.gold} é‡‘å¸
                                    </span>
                                    ${game.cs ? `<span class="badge stats-badge bg-info">
                                        <i class="bi bi-bullseye me-1"></i>
                                        ${game.cs} CS
                                    </span>` : ''}
                                </div>
                            </div>

                            <!-- å³ä¾§ï¼šæ—¶é—´å’Œåºå· -->
                            <div class="col-md-4 col-sm-4 text-end">
                                <small class="text-muted d-block mb-2">
                                    <i class="bi bi-clock me-1"></i>${game.time_ago}
                                </small>
                                <span class="badge bg-light text-dark">ç¬¬ ${index + 1} åœº</span>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleMatchDetails(${index})" type="button">
                                        <i class="bi bi-chevron-down me-1"></i>å±•å¼€å¯¹å±€
                                    </button>
                                    <a class="btn btn-sm btn-outline-secondary ms-2" 
                                        href="/match/${encodeURIComponent(summonerName)}/${index}?match_id=${encodeURIComponent(game.match_id || '')}"
                                        target="_blank" rel="noopener noreferrer">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>åœ¨æ–°é¡µæ‰“å¼€
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- inline details container (collapsed by default) -->
                    <div id="match-details-${index}" class="collapse ps-3 pe-3 pb-3"></div>
                </div>
            `;
        }).join('');
    }

    async function toggleMatchDetails(index) {
        const detailsId = `match-details-${index}`;
        const el = document.getElementById(detailsId);
        if (!el) return;

        // If content already loaded, just toggle
        if (el.dataset.loaded === 'true') {
            // bootstrap collapse toggle
            const bsCollapse = new bootstrap.Collapse(el, {toggle: true});
            return;
        }

        // show spinner while loading
        el.innerHTML = `<div class="text-center py-3"><div class="spinner-border" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div></div>`;
        const bs = new bootstrap.Collapse(el, {toggle: true});

        try {
            const games = window._games || [];
            const gameMeta = games[index];
            let resp;
            if (gameMeta && gameMeta.match_id) {
                resp = await fetch(`/get_match?match_id=${encodeURIComponent(gameMeta.match_id)}`);
            } else {
                resp = await fetch(`/get_match?name=${encodeURIComponent(summonerName)}&index=${index}`);
            }
            const data = await resp.json();
            console.debug('get_match response for index', index, data);
            if (!data.success) {
                el.innerHTML = `<div class="alert alert-warning">æ— æ³•è·å–å¯¹å±€è¯¦æƒ…: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                el.dataset.loaded = 'true';
                return;
            }

            const game = data.game;
            try {
                el.innerHTML = renderInlineMatchDetail(game);
            } catch (renderErr) {
                console.error('renderInlineMatchDetail failed', renderErr, game);
                el.innerHTML = `<div class="alert alert-danger">æ¸²æŸ“å¯¹å±€è¯¦æƒ…å¤±è´¥ï¼ˆæ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ï¼‰</div>`;
            }
            el.dataset.loaded = 'true';
        } catch (e) {
            console.error(e);
            el.innerHTML = `<div class="alert alert-danger">åŠ è½½å¯¹å±€è¯¦æƒ…å¤±è´¥</div>`;
            el.dataset.loaded = 'true';
        }
    }

    // é€šç”¨ç©å®¶ä¿¡æ¯æ¸²æŸ“å‡½æ•°ï¼ˆCHERRY å’Œæ™®é€šæ¨¡å¼å…±ç”¨ï¼‰
    function renderPlayerHtml(p, idx) {
        const name = p.summonerName || (p.player && (p.player.gameName ? (p.player.gameName + (p.player.tagLine ? ('#'+p.player.tagLine) : '')) : p.player.summonerName)) || 'æœªçŸ¥';
        const playerPuuid = p.puuid || (p.player && p.player.puuid) || '';
        const icon = p.profileIcon || (p.player && (p.player.profileIcon)) || p.profileIconId || '';
        // resolve champion image key via CHAMPION_MAP (server-provided)
        const champKey = (p.championId && CHAMPION_MAP && CHAMPION_MAP[p.championId]) ? CHAMPION_MAP[p.championId] : (p.champion || p.championName || '');
        const champImg = champKey ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/champion/${champKey}.png" class="champion-icon me-2" onerror="this.style.display='none'">` : '';
        const level = (p.stats && p.stats.champLevel) || p.champLevel || 0;
        const champWrapper = champImg ? `<div class="champion-wrapper">${champImg}${level?`<span class="level-badge">${level}</span>`:''}</div>` : '';
        const k = p.stats ? p.stats.kills : (p.kills || 0);
        const d = p.stats ? p.stats.deaths : (p.deaths || 0);
        const a = p.stats ? p.stats.assists : (p.assists || 0);
        const gold = (p.stats && p.stats.goldEarned) || p.gold || 0;
        const cs = (p.stats && ((p.stats.totalMinionsKilled||0)+(p.stats.neutralMinionsKilled||0))) || p.cs || 0;
        const damage = (p.stats && (p.stats.totalDamageDealtToChampions || 0)) || p.totalDamageDealtToChampions || 0;
        const heal = (p.stats && p.stats.totalHeal) || p.totalHeal || 0;
        const vision = (p.stats && p.stats.visionScore) || p.visionScore || 0;
        const items = [];
        if (p.stats) {
            for (let i=0;i<7;i++) { const key='item'+i; if (p.stats[key] !== undefined) items.push(p.stats[key]); }
        }
        const itemsHtml = items.map(id => id ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/item/${id}.png" class="item-icon" onerror="this.style.display='none'">` : '').join('');
        
        // æå–å¢å¼ºï¼ˆAugmentsï¼‰- KIWI/CHERRYæ¨¡å¼
        let augmentsHtml = '';
        if (p.stats && p.stats.playerAugment1) {
            const augments = [];
            for (let i = 1; i <= 6; i++) {
                const augId = p.stats['playerAugment' + i];
                const augIconUrl = p.stats['augmentIcon' + i];
                const augName = p.stats['augmentName' + i];
                const augDesc = p.stats['augmentDesc' + i];
                if (augId && augId > 0) {
                    augments.push({ id: augId, iconUrl: augIconUrl, name: augName, desc: augDesc });
                }
            }
            if (augments.length > 0) {
                augmentsHtml = `<div class="augments-row small mt-1">
                    ${augments.map(aug => {
                        // æ„å»ºtooltipå†…å®¹ï¼ˆä¸­æ–‡åç§°+æè¿°ï¼‰
                        let tooltip = aug.name || `æµ·å…‹æ–¯å¤©èµ‹ ${aug.id}`;
                        if (aug.desc) {
                            // æ¸…ç†HTMLæ ‡ç­¾å¹¶æˆªæ–­æè¿°
                            const cleanDesc = aug.desc.replace(/<[^>]+>/g, '').substring(0, 200);
                            tooltip = `${aug.name}\\n${cleanDesc}${cleanDesc.length >= 200 ? '...' : ''}`;
                        }
                        
                        if (aug.iconUrl) {
                            return `<img src="${aug.iconUrl}" 
                                class="augment-icon" 
                                title="${tooltip.replace(/"/g, '&quot;')}" 
                                onerror="this.onerror=null;this.outerHTML='<span class=\\'badge\\' style=\\'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 2px 6px;\\' title=\\'${tooltip.replace(/"/g, '&quot;')}\\'>âš¡${aug.id}</span>';">`;
                        } else {
                            // å¦‚æœæ²¡æœ‰å›¾æ ‡URLï¼Œæ˜¾ç¤ºæ–‡æœ¬å¾½ç« 
                            return `<span class='badge' style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 2px 6px;' title='${tooltip.replace(/"/g, '&quot;')}'>âš¡${aug.id}</span>`;
                        }
                    }).join(' ')}
                </div>`;
            }
        }
        
        const profileImg = icon ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/${icon}.png" class="profile-img" onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/29.png';">` : `<div class="profile-placeholder"></div>`;
        // clickable area uses inline style to look like plain text (no blue/underline)
        const playerLink = `/summoner/${encodeURIComponent(name)}?puuid=${encodeURIComponent(playerPuuid)}`;
        const ratio = d > 0 ? ((k + a) / d) : (k + a);
        const ratioNum = Math.round(ratio * 100) / 100;
        const ratioStr = ratioNum.toFixed(2);
        let kdaClass = 'kda-bad';
        if (ratioNum >= 5) kdaClass = 'kda-good';
        else if (ratioNum >= 3) kdaClass = 'kda-mid';

        return `
            <div class="match-row ${p.win ? 'win-row' : ''}">
                <div class="col-player-info">
                    <a href="${playerLink}" class="player-link" target="_blank">${profileImg}</a>
                    <div>
                        <div class="player-name"><a href="${playerLink}" class="player-link player-name" target="_blank">${name}</a></div>
                        <div class="small-muted">${p.role || ''} ${p.lane || ''}</div>
                        ${augmentsHtml}
                    </div>
                </div>
                <div class="col-champion">${champWrapper}</div>
                <div class="col-kda">
                    <span class="kda-prominent ${kdaClass}">${k}/${d}/${a}</span>
                    <div class="small-muted">${ratioStr} KDA</div>
                </div>
                <div class="col-items-wrapper">
                    <div class="items-row">${itemsHtml}</div>
                    <div class="stats-row small-muted">${fmt(gold)}g Â· ${cs} CS Â· ${fmt(damage)} DMG</div>
                </div>
            </div>`;
    }

    // CHERRY æ¨¡å¼æ¸²æŸ“å‡½æ•°
    function renderCherryMode(game, sortedSubteams) {
        // å‰4åä¸ºè·èƒœé˜Ÿä¼
        const winningSubteams = sortedSubteams.filter(t => t.placement <= 4);
        const losingSubteams = sortedSubteams.filter(t => t.placement > 4);
        
        function subteamHtml(subteam) {
            const placement = subteam.placement;
            const isWinning = placement <= 4;
            const rankEmoji = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£'][placement - 1] || `#${placement}`;
            
            return `
                <div class="mb-3 p-2 rounded ${isWinning ? 'bg-light-success' : 'bg-light'}" style="border-left: 4px solid ${isWinning ? '#28a745' : '#6c757d'}">
                    <h6 class="mb-2">
                        <span class="badge ${isWinning ? 'bg-success' : 'bg-secondary'}">${rankEmoji} æ’å ${placement}</span>
                        <span class="badge bg-info ms-2">å­é˜Ÿ ${subteam.subteamId}</span>
                    </h6>
                    ${subteam.players.map((p, i) => renderPlayerHtml(p, i)).join('')}
                </div>
            `;
        }
        
        let headerTimeHtml = '';
        try {
            if (game.gameCreation) {
                const durationSec = game.gameDuration || 0;
                const start = new Date(game.gameCreation);
                const end = new Date(game.gameCreation + (durationSec * 1000));
                const minutes = Math.floor(durationSec / 60);
                const seconds = durationSec % 60;
                headerTimeHtml = `<div class="mb-2 text-muted">
                    <span class="badge bg-primary me-2">æ–—é­‚ç«æŠ€åœº (2v2v2v2)</span>
                    æ—¶é•¿: ${minutes} åˆ† ${seconds} ç§’ â€¢ å¼€å§‹: ${start.toLocaleString()} â€¢ ç»“æŸ: ${end.toLocaleString()}
                </div>`;
            }
        } catch(e) { headerTimeHtml = ''; }
        
        return `
            <div class="card mt-2">
                <div class="card-body">
                    ${headerTimeHtml}
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-success mb-3">
                                <i class="bi bi-trophy-fill me-2"></i>è·èƒœé˜Ÿä¼ (å‰4å)
                            </h5>
                            ${winningSubteams.map(st => subteamHtml(st)).join('')}
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-secondary mb-3">
                                <i class="bi bi-x-circle-fill me-2"></i>å¤±è´¥é˜Ÿä¼ (å4å)
                            </h5>
                            ${losingSubteams.map(st => subteamHtml(st)).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderInlineMatchDetail(game) {
        if (!game) return `<div class="text-muted">æ— å¯¹å±€æ•°æ®</div>`;
        const participants = game.participants || [];
        const gameMode = game.gameMode || '';
        
        // CHERRY æ¨¡å¼ï¼šæŒ‰å­é˜Ÿä¼åˆ†ç»„
        const isCherryMode = gameMode === 'CHERRY';
        
        if (isCherryMode) {
            // æŒ‰å­é˜Ÿä¼åˆ†ç»„
            const subteams = {};
            participants.forEach(p => {
                const subteamId = (p.stats && p.stats.playerSubteamId) || 0;
                if (!subteams[subteamId]) {
                    subteams[subteamId] = {
                        players: [],
                        placement: (p.stats && p.stats.subteamPlacement) || 0
                    };
                }
                subteams[subteamId].players.push(p);
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ’åæ’åº
            const sortedSubteams = Object.entries(subteams)
                .map(([id, data]) => ({ subteamId: id, ...data }))
                .sort((a, b) => a.placement - b.placement);
            
            return renderCherryMode(game, sortedSubteams);
        }
        
        // æ™®é€šæ¨¡å¼ï¼šæŒ‰é˜Ÿä¼åˆ†ç»„
        const teamA = participants.filter(p => p.teamId === 100);
        const teamB = participants.filter(p => p.teamId === 200);
    // determine winning teamId from game.teams if present
        const winningTeamId = (game.teams || []).reduce((winId, t) => {
            // some payloads use 'win': 'Win' or boolean true
            if (t.win === true || String(t.win).toLowerCase() === 'win') return t.teamId || winId;
            return winId;
        }, null);

        // show start/end times and duration above teams
        let headerTimeHtml = '';
        try {
            if (game.gameCreation) {
                const durationSec = game.gameDuration || 0;
                const start = new Date(game.gameCreation);
                const end = new Date(game.gameCreation + (durationSec * 1000));
                const minutes = Math.floor(durationSec / 60);
                const seconds = durationSec % 60;
                headerTimeHtml = `<div class="mb-2 text-muted">æ—¶é•¿: ${minutes} åˆ† ${seconds} ç§’ â€¢ å¼€å§‹: ${start.toLocaleString()} â€¢ ç»“æŸ: ${end.toLocaleString()}</div>`;
            }
        } catch(e) { headerTimeHtml = ''; }
        return `
            <div class="card mt-2">
                <div class="card-body">
                    ${headerTimeHtml}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>é˜Ÿä¼ 1 ${winningTeamId === 100 ? '<span class="badge bg-success ms-2">èƒœåˆ©</span>' : ''}</h6>
                            ${teamA.map((p,i) => renderPlayerHtml(p,i)).join('')}
                        </div>
                        <div class="col-md-6">
                            <h6>é˜Ÿä¼ 2 ${winningTeamId === 200 ? '<span class="badge bg-success ms-2">èƒœåˆ©</span>' : ''}</h6>
                            ${teamB.map((p,i) => renderPlayerHtml(p,i)).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', loadSummonerDetails);
</script>

</body>
</html>
