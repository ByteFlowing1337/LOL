<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ summoner_name }} - è¯¦ç»†æˆ˜ç»©</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    
    <style>
        body {
            background: #ffffff;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .container {
            max-width: 1400px;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        /* Header Styling */
        .header-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 2rem;
        }
        .summoner-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .summoner-level-badge {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
            display: inline-block;
            margin-top: 8px;
        }
        .ranked-badge {
            padding: 6px 14px;
            border-radius: 18px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
            margin-right: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .ranked-badge.iron { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; }
        .ranked-badge.bronze { background: linear-gradient(135deg, #cd7f32 0%, #8b5a2b 100%); color: white; }
        .ranked-badge.silver { background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%); color: white; }
        .ranked-badge.gold { background: linear-gradient(135deg, #ffd700 0%, #daa520 100%); color: #1a202c; }
        .ranked-badge.platinum { background: linear-gradient(135deg, #00ced1 0%, #008b8b 100%); color: white; }
        .ranked-badge.emerald { background: linear-gradient(135deg, #50c878 0%, #3cb371 100%); color: white; }
        .ranked-badge.diamond { background: linear-gradient(135deg, #b9f2ff 0%, #6fa8dc 100%); color: #1a202c; }
        .ranked-badge.master { background: linear-gradient(135deg, #9b30ff 0%, #7b2cbf 100%); color: white; }
        .ranked-badge.grandmaster { background: linear-gradient(135deg, #ff4d4d 0%, #c41e3a 100%); color: white; }
        .ranked-badge.challenger { background: linear-gradient(135deg, #f4c430 0%, #ffdf00 100%); color: #1a202c; box-shadow: 0 3px 15px rgba(244,196,48,0.5); }
        .ranked-badge.unranked { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; opacity: 0.7; }
        .stats-badge:hover {
            transform: scale(1.05);
        }
        
        /* KDA Badge - é˜²æ­¢æ¢è¡Œ */
        .kda-badge {
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            vertical-align: middle;
        }
        .kda-badge i {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Specific Badge Colors */
        .badge-kda { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .badge-ratio-high { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; }
        .badge-ratio-mid { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .badge-ratio-low { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .badge-gold { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: #1a202c; }
        .badge-cs { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; }
        
        /* Items Enhanced */
        .items-col { 
            display: flex; 
            gap: 6px; 
            align-items: center; 
            flex-wrap: wrap;
        }
        .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #ddd;
            margin: 2px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            transition: transform 0.2s ease;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            flex-shrink: 0;
        }
        .item-icon:hover {
            transform: scale(1.1);
        }
        
        /* è¯¦æƒ…è§†å›¾ä¸­çš„ç‰©å“å›¾æ ‡ - æ›´ç´§å‡‘ */
        .match-details .item-icon {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            margin: 0 1px;
            flex-shrink: 0; /* é˜²æ­¢å‹ç¼© */
        }
        
        /* Augments Enhanced */
        .augments-container { 
            max-width: 500px; 
            overflow: hidden; 
        }
        .augment-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #667eea;
            margin: 0 2px;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2px;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }
        .augment-icon:hover {
            transform: scale(1.1);
        }
        .augments-row {
            display: flex;
            align-items: center;
            flex-wrap: nowrap; /* ä¸æ¢è¡Œ */
            margin-top: 4px;
            gap: 2px;
            max-width: 100%;
            overflow: hidden;
            min-height: 24px; /* å›ºå®šæœ€å°é«˜åº¦ */
        }
        
        /* Layout Improvements */
        .game-card .card-body .row > div {
            display: flex;
            align-items: center;
        }
        .game-card .col-champion { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            padding-left: 30px !important; /* å‘å³ç§»åŠ¨ï¼Œæ›´é è¿‘ä¸­é—´ */
        }
        .game-card .col-info { 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center; /* æ°´å¹³å±…ä¸­å¯¹é½ */
        }
        .game-card .col-info > div {
            width: 100%; /* ç¡®ä¿å­å…ƒç´ å æ»¡å®½åº¦ */
            display: flex;
            justify-content: center; /* å†…å®¹å±…ä¸­ */
            flex-wrap: wrap;
        }
        .game-card .col-meta { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: flex-end; 
        }
        
        /* Summary Cards */
        .summary-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 1rem;
        }
        
        /* Back Button */
        .back-button {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        /* Loading and Error States */
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .champion-icon { width: 60px; height: 60px; }
            .level-badge { width: 24px; height: 24px; font-size: 0.7rem; }
            .item-icon { width: 32px; height: 32px; }
            .augment-icon { width: 24px; height: 24px; }
            .stats-badge { font-size: 0.75rem; padding: 4px 8px; }
        }
        
        /* Game Detail Stats */
        .detail-stats {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.1) 0%, rgba(74, 20, 140, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            transform: translateX(4px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-weight: 500;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-label i {
            font-size: 0.9em;
            opacity: 0.7;
        }
        
        .stat-value {
            font-weight: bold;
            color: #ffd700;
            background: linear-gradient(45deg, #ffd700 0%, #ffed4e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gold-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        .damage-bar {
            height: 6px;
            border-radius: 3px;
            margin-top: 3px;
            overflow: hidden;
        }
        
        .damage-segment {
            height: 100%;
            float: left;
        }
        
        .damage-physical { background-color: #d97728; }
        .damage-magic { background-color: #b833cc; }
        .damage-true { background-color: #969696; }
        
        .player-row:hover .damage-bar {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .bg-light-success {
            background-color: #d4edda !important;
        }
        .subteam-card {
            transition: all 0.2s ease;
        }
        .subteam-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        /* KIWI æ¨¡å¼ç´«è‰²å¾½ç«  */
        .bg-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        /* è¯¦ç»†å¯¹å±€å‚ä¸è€…æ ·å¼ */
        .match-row {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            transition: all 0.2s ease;
            gap: 15px;
            width: 100%;
            min-width: 0; /* å…è®¸flexå­é¡¹æ”¶ç¼© */
            position: relative; /* ç¡®ä¿æ‚¬åœæ•ˆæœä¸å½±å“å¸ƒå±€ */
            z-index: 1; /* åŸºç¡€å±‚çº§ */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            min-height: 70px; /* å›ºå®šæœ€å°é«˜åº¦ï¼Œç¡®ä¿æ‰€æœ‰å¡ç‰‡é«˜åº¦ä¸€è‡´ */
        }
        .match-row:hover {
            background: #f8f9fa;
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            z-index: 10; /* æ‚¬åœæ—¶æå‡å±‚çº§ */
        }
        .match-row.win-row {
            border-left-color: #28a745;
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.05) 0%, white 100%);
        }
        
        /* å‚ä¸è€…å„åˆ—æ ·å¼ */
        .col-player-info {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex: 0 0 180px;
            overflow: hidden;
        }
        .col-player-info > div {
            flex: 1;
            min-width: 0;
        }
        .col-champion {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
            flex: 0 0 60px;
        }
        .col-kda {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* å‚ç›´å±…ä¸­ */
            min-width: 0;
            flex: 0 0 90px;
        }
        .col-items-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center; /* å‚ç›´å±…ä¸­ */
            gap: 6px;
            flex: 1 1 auto;
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
            min-height: 46px; /* å›ºå®šæœ€å°é«˜åº¦ï¼Œå®¹çº³è£…å¤‡å›¾æ ‡ */
        }
        
        /* å¤´åƒå’Œåå­— */
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            flex-shrink: 0;
        }
        .profile-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            flex-shrink: 0;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        .player-link {
            text-decoration: none;
            color: inherit;
        }
        .player-link:hover {
            color: #667eea;
        }
        .small-muted {
            font-size: 11px;
            color: #6c757d;
        }
        
        /* KDA æ ·å¼ */
        .kda-prominent {
            font-weight: bold;
            font-size: 15px;
            color: #2c3e50; /* é»˜è®¤æ·±è‰²ï¼Œç¡®ä¿å¯è¯»æ€§ */
            text-shadow: 0 1px 2px rgba(255,255,255,0.8); /* æ·»åŠ ç™½è‰²é˜´å½±å¢å¼ºå¯¹æ¯”åº¦ */
        }
        /* è¯¦æƒ…è§†å›¾ä¸­çš„KDAä½¿ç”¨æ›´æ˜æ˜¾çš„é¢œè‰² */
        .match-details .kda-good { 
            color: #1e8449;
            font-weight: 900;
        }
        .match-details .kda-mid { 
            color: #1f618d;
            font-weight: 900;
        }
        .match-details .kda-bad { 
            color: #c0392b;
            font-weight: 900;
        }
        /* ä¸»åˆ—è¡¨ä¸­çš„KDAé¢œè‰²ï¼ˆåŸæ¥çš„ï¼‰ */
        .kda-good { color: #27ae60; }
        .kda-mid { color: #3498db; }
        .kda-bad { color: #e74c3c; }
        
        /* ç‰©å“å’Œç»Ÿè®¡è¡Œ */
        .items-row {
            display: flex;
            gap: 3px;
            flex-wrap: nowrap; /* ä¸æ¢è¡Œï¼Œä¿æŒåœ¨ä¸€è¡Œå†… */
            max-width: 100%;
            overflow: hidden; /* è¶…å‡ºéƒ¨åˆ†éšè— */
            align-items: center;
            min-height: 34px; /* å›ºå®šé«˜åº¦å®¹çº³ä¸€è¡Œç‰©å“å›¾æ ‡ */
        }
        .stats-row {
            color: #6c757d;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        
        /* è‹±é›„å¤´åƒï¼ˆè¯¦æƒ…ä¸­çš„ï¼‰ */
        .champion-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .champion-wrapper {
            position: relative;
            display: inline-block;
        }
        .champion-wrapper .level-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: #2c3e50;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            min-width: 20px;
            text-align: center;
        }
        
        /* è¯¦æƒ…å®¹å™¨å®½åº¦æ‰©å±• */
        .detail-stats {
            width: 100%;
            max-width: none !important;
        }
        .detail-stats .card {
            max-width: 100%;
        }
        .detail-stats .card-body {
            padding: 20px;
        }
        .detail-stats .row {
            margin: 0 -10px;
        }
        .detail-stats .col-md-6 {
            padding: 0 10px;
        }
        
        /* ä¸‹æ‹‰è¯¦æƒ…å®¹å™¨ - å…³é”®ä¿®å¤ï¼šç¡®ä¿å®¹å™¨é«˜åº¦è‡ªé€‚åº” */
        .match-details {
            width: 100%;
            overflow: visible !important;
            min-height: auto;
            height: auto !important;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .match-details .card {
            width: 100%;
            overflow: visible;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .match-details .card-body {
            overflow: visible;
            padding: 25px;
            background: #f8f9fa;
        }
        .match-details .row {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-start;
            gap: 20px;
        }
        .match-details .col-md-6 {
            flex: 0 0 calc(50% - 10px);
            max-width: calc(50% - 10px);
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        .match-details h6 {
            margin-bottom: 15px;
            font-weight: bold;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination-btn {
            padding: 10px 20px;
            margin: 0 5px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: #007bff;
            color: white;
        }
        .page-info {
            padding: 10px 20px;
            margin: 0 10px;
            font-weight: 600;
            color: #495057;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="d-flex align-items-center">
            <img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/{{ profile_icon_id }}.png" 
                 class="summoner-icon me-4" 
                 onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/29.png';"
                 alt="å¬å”¤å¸ˆå¤´åƒ">
            <div>
                <h1 class="display-4 fw-bold text-dark mb-2">{{ summoner_name }}</h1>
                <p class="lead text-muted mb-0">è¯¦ç»†å†å²æˆ˜ç»©åˆ†æ</p>
                {% if summoner_level > 0 %}
                <span class="summoner-level-badge">ç­‰çº§ {{ summoner_level }}</span>
                {% endif %}
                {% if ranked_solo_tier %}
                <span class="ranked-badge {{ ranked_solo_tier|lower }}">
                    å•æ’: {{ ranked_solo_tier }} {{ ranked_solo_rank }} - {{ ranked_solo_lp }} LP
                </span>
                {% endif %}
                {% if ranked_flex_tier %}
                <span class="ranked-badge {{ ranked_flex_tier|lower }}">
                    çµæ´»: {{ ranked_flex_tier }} {{ ranked_flex_rank }} - {{ ranked_flex_lp }} LP
                </span>
                {% endif %}
            </div>
            <a href="/" class="btn btn-outline-secondary ms-auto">è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <div id="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <p class="mt-3 text-muted">æ­£åœ¨åŠ è½½æˆ˜ç»©æ•°æ®...</p>
    </div>

    <div id="stats-summary" class="row mb-4" style="display: none;">
        <!-- ç»Ÿè®¡æ‘˜è¦å°†ç”±JavaScriptå¡«å…… -->
    </div>

    <div id="games-container">
        <!-- æ¸¸æˆåˆ—è¡¨å°†ç”±JavaScriptå¡«å…… -->
    </div>

    <div id="pagination-container" class="d-flex justify-content-center mt-4" style="display: none;">
        <!-- åˆ†é¡µæ§ä»¶å°†ç”±JavaScriptå¡«å…… -->
    </div>

    <div id="error-message" class="alert alert-danger d-none" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="error-text"></span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Server-provided data (JSON) to avoid embedding raw Jinja in JS code that breaks editor linting -->
<script id="server-data" type="application/json">{{ {'summoner_name': summoner_name, 'puuid': (puuid if puuid is defined else ''), 'champion_map': (champion_map if champion_map is defined else {}) }|tojson }}</script>
<script>
    const SERVER_DATA = JSON.parse(document.getElementById('server-data').textContent || '{}');
    const summonerName = SERVER_DATA.summoner_name || '';
    const summonerPuuid = SERVER_DATA.puuid || '';
    const CHAMPION_MAP = SERVER_DATA.champion_map || {};
    
    // Small helper for compact number formatting: 14300 -> 14.3k
    function fmt(n){
        if (n === null || n === undefined) return '';
        if (Math.abs(n) >= 1000) return (n/1000).toFixed(1).replace(/\.0$/,'')+'k';
        return ''+n;
    }

    let currentPage = 1;
    const gamesPerPage = 20;

    async function loadSummonerDetails(page = 1) {
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const gamesContainer = document.getElementById('games-container');
        const summaryDiv = document.getElementById('stats-summary');
        const paginationContainer = document.getElementById('pagination-container');

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        loadingDiv.style.display = 'block';
        errorDiv.classList.add('d-none');
        gamesContainer.innerHTML = '';
        summaryDiv.style.display = 'none';
        paginationContainer.style.display = 'none';

        try {
            let historyUrl = '';
            if (summonerPuuid && summonerPuuid.length > 0) {
                historyUrl = `/get_history?puuid=${encodeURIComponent(summonerPuuid)}&page=${page}`;
            } else {
                historyUrl = `/get_history?name=${encodeURIComponent(summonerName)}&page=${page}`;
            }
            const response = await fetch(historyUrl);
            const data = await response.json();

            loadingDiv.style.display = 'none';

            if (!data.success || !data.games || data.games.length === 0) {
                errorDiv.classList.remove('d-none');
                errorText.textContent = data.message || 'æœªæ‰¾åˆ°æˆ˜ç»©æ•°æ®';
                return;
            }

            currentPage = page;

            // æ˜¾ç¤ºç»Ÿè®¡æ‘˜è¦
            displayStatsSummary(data.games, summaryDiv);
            
            // æ˜¾ç¤ºæ¸¸æˆåˆ—è¡¨
            displayGames(data.games, gamesContainer);

            // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
            displayPagination(data.games.length, paginationContainer);

        } catch (error) {
            console.error('åŠ è½½æˆ˜ç»©å¤±è´¥:', error);
            loadingDiv.style.display = 'none';
            errorDiv.classList.remove('d-none');
            errorText.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        }
    }

    function displayPagination(gamesCount, container) {
        if (gamesCount === 0) {
            container.style.display = 'none';
            return;
        }

        const hasPrev = currentPage > 1;
        const hasNext = gamesCount >= gamesPerPage; // å¦‚æœå½“å‰é¡µæœ‰20åœºæ¸¸æˆï¼Œå¯èƒ½è¿˜æœ‰ä¸‹ä¸€é¡µ
        
        // æ•è·å½“å‰é¡µç å€¼ï¼Œé¿å…é—­åŒ…é—®é¢˜
        const prevPage = currentPage - 1;
        const nextPage = currentPage + 1;

        container.innerHTML = `
            <button class="pagination-btn" id="prev-page-btn" ${!hasPrev ? 'disabled' : ''}>
                <i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ
            </button>
            <span class="page-info">ç¬¬ ${currentPage} é¡µ</span>
            <button class="pagination-btn" id="next-page-btn" ${!hasNext ? 'disabled' : ''}>
                ä¸‹ä¸€é¡µ <i class="bi bi-chevron-right"></i>
            </button>
        `;
        container.style.display = 'flex';
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - ä½¿ç”¨æ•è·çš„é¡µç å€¼
        if (hasPrev) {
            document.getElementById('prev-page-btn').addEventListener('click', () => loadPage(prevPage));
        }
        if (hasNext) {
            document.getElementById('next-page-btn').addEventListener('click', () => loadPage(nextPage));
        }
    }

    function loadPage(page) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        loadSummonerDetails(page);
    }

    function displayStatsSummary(games, container) {
        const totalGames = games.length;
        const wins = games.filter(g => g.win).length;
        const losses = totalGames - wins;
        const winRate = ((wins / totalGames) * 100).toFixed(1);

        let totalKills = 0, totalDeaths = 0, totalAssists = 0;
        games.forEach(game => {
            const [k, d, a] = game.kda.split('/').map(Number);
            totalKills += k;
            totalDeaths += d;
            totalAssists += a;
        });

        const avgKills = (totalKills / totalGames).toFixed(1);
        const avgDeaths = (totalDeaths / totalGames).toFixed(1);
        const avgAssists = (totalAssists / totalGames).toFixed(1);
        const kdaRatio = totalDeaths > 0 ? ((totalKills + totalAssists) / totalDeaths).toFixed(2) : 'Perfect';

        container.innerHTML = `
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-controller fs-2 text-primary mb-2"></i>
                        <h6 class="text-muted">æ€»åœºæ¬¡</h6>
                        <h3 class="mb-0 fw-bold">${totalGames}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-trophy fs-2 ${winRate >= 50 ? 'text-success' : 'text-danger'} mb-2"></i>
                        <h6 class="text-muted">èƒœç‡</h6>
                        <h3 class="mb-0 fw-bold ${winRate >= 50 ? 'text-success' : 'text-danger'}">${winRate}%</h3>
                        <small class="text-muted">${wins}èƒœ ${losses}è´¥</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up fs-2 text-info mb-2"></i>
                        <h6 class="text-muted">å¹³å‡KDA</h6>
                        <h3 class="mb-0 fw-bold text-info">${avgKills}/${avgDeaths}/${avgAssists}</h3>
                        <small class="text-muted">æ¯”å€¼: ${kdaRatio}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-star fs-2 text-warning mb-2"></i>
                        <h6 class="text-muted">æ€»å‡»æ€</h6>
                        <h3 class="mb-0 fw-bold text-warning">${totalKills}</h3>
                        <small class="text-muted">æ€»åŠ©æ”»: ${totalAssists}</small>
                    </div>
                </div>
            </div>
        `;
        container.style.display = 'flex';
    }

    function getMostPlayedChampion(games) {
        const champCount = {};
        games.forEach(game => {
            champCount[game.champion_en] = (champCount[game.champion_en] || 0) + 1;
        });
        const mostPlayed = Object.entries(champCount).sort((a, b) => b[1] - a[1])[0];
        return mostPlayed ? `${mostPlayed[0]} (${mostPlayed[1]}åœº)` : 'N/A';
    }

    // æ¸¸æˆæ¨¡å¼åç§°æ˜ å°„
    function getModeName(mode) {
        const modeMap = {
            'CLASSIC': 'ç»å…¸æ¨¡å¼',
            'ARAM': 'æåœ°å¤§ä¹±æ–—',
            'KIWI': 'æµ·å…‹æ–¯å¤§ä¹±æ–—',
            'CHERRY': 'æ–—é­‚ç«æŠ€åœº',
            'URF': 'æ— é™ç«åŠ›',
            'ONEFORALL': 'å…‹éš†æ¨¡å¼',
            'NEXUSBLITZ': 'æ¿€æ–—å³¡è°·',
            'TUTORIAL': 'æ•™ç¨‹',
            'PRACTICETOOL': 'è®­ç»ƒæ¨¡å¼'
        };
        return modeMap[mode] || mode;
    }

    function displayGames(games, container) {
        // keep games globally so toggleMatchDetails can access them
        window._games = games;

        container.innerHTML = games.map((game, index) => {
            const isCherryMode = game.mode === 'CHERRY' || game.gameMode === 'CHERRY' || game.mode === 'æ–—é­‚ç«æŠ€åœº';

            // è®¡ç®—å…¨å±€æ¸¸æˆç¼–å·ï¼šå½“å‰é¡µ * æ¯é¡µæ•°é‡ + ç´¢å¼• + 1
            const globalIndex = (currentPage - 1) * gamesPerPage + index + 1;

            // ç›´æ¥ä½¿ç”¨gameå¯¹è±¡çš„winå­—æ®µï¼ˆåç«¯å·²å¤„ç†å¥½ï¼‰
            const won = game.win === true || game.win === 'true' || String(game.win).toLowerCase() === 'win';
            const winClass = won ? 'win-bg' : 'loss-bg';
            const winText = isCherryMode ? 'æ–—é­‚ç«æŠ€åœº' : (won ? 'èƒœåˆ©' : 'å¤±è´¥');
            const winIcon = won ? 'trophy-fill text-success' : 'x-circle-fill text-danger';

            // è§£æKDA
            let kills=0, deaths=0, assists=0;
            if (game.kda && typeof game.kda === 'string' && game.kda.indexOf('/')>-1) {
                [kills, deaths, assists] = game.kda.split('/').map(x=>parseInt(x)||0);
            }
            const kda = deaths > 0 ? (((kills||0) + (assists||0)) / (deaths||1)).toFixed(2) : 'Perfect';

            // è‹±é›„ç­‰çº§ï¼šåç«¯ç®€åŒ–æ•°æ®æ²¡æœ‰champion_levelï¼Œéœ€è¦é€šè¿‡è¯¦ç»†æ•°æ®è·å–ï¼Œæš‚æ—¶æ˜¾ç¤ºä¸ºç©ºæˆ–ä»KDAæ¨æµ‹
            // ç”±äºåç«¯è¿”å›çš„ç®€åŒ–åˆ—è¡¨æ²¡æœ‰ç­‰çº§ä¿¡æ¯ï¼Œæˆ‘ä»¬å…ˆä¸æ˜¾ç¤ºæˆ–æ˜¾ç¤º"--"
            const championLevel = game.champion_level || game.championLevel || game.level || '';

            // é‡‘å¸ï¼šåç«¯å·²ç»æ˜¯kå•ä½ï¼ˆ12è¡¨ç¤º12kï¼‰ï¼Œç›´æ¥æ˜¾ç¤º
            const goldVal = game.gold || 0;
            // åç«¯è¿”å›çš„goldå·²ç»æ˜¯kä¸ºå•ä½ï¼ˆä¾‹å¦‚12 = 12kï¼‰ï¼Œç›´æ¥æ·»åŠ kåç¼€
            let goldFormatted;
            if (goldVal > 0 && goldVal < 1000) {
                // å°äº1000è¯´æ˜æ˜¯kå•ä½ï¼Œç›´æ¥åŠ k
                goldFormatted = goldVal + 'k';
            } else if (goldVal >= 1000) {
                // å¤§äºç­‰äº1000è¯´æ˜æ˜¯åŸå§‹é‡‘å¸å€¼ï¼Œéœ€è¦æ ¼å¼åŒ–
                goldFormatted = fmt(goldVal);
            } else {
                goldFormatted = '0';
            }

            return `
                <div class="card game-card ${winClass}">
                    <div class="card-body p-4">
                        <div class="row align-items-center g-3">
                            <!-- å·¦ä¾§ï¼šè‹±é›„ä¿¡æ¯ -->
                            <div class="col-md-2 col-champion">
                                <div class="champion-wrapper">
                                    <img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/champion/${game.champion_en || ''}.png" 
                                         alt="${game.champion_en || ''}" 
                                         class="champion-icon">
                                    ${championLevel ? `<div class="level-badge">${championLevel}</div>` : ''}
                                </div>
                                <h6 class="mt-2 mb-0 text-center fw-bold">${game.champion_en || ''}</h6>
                            </div>

                            <!-- ä¸­é—´ï¼šæˆ˜ç»©æ•°æ® -->
                            <div class="col-md-6 col-info">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-${winIcon} me-2 fs-4"></i>
                                    <h5 class="mb-0 fw-bold me-3">${winText}</h5>
                                    <span class="badge mode-badge">
                                        ${getModeName(game.gameMode || game.mode)}
                                    </span>
                                </div>
                                
                                <div class="mb-3 d-flex align-items-center flex-wrap gap-2">
                                    <span class="kda-badge">
                                        <i class="bi bi-diagram-3 me-1"></i>
                                        ${kills}/${deaths}/${assists}
                                    </span>
                                    <span class="badge stats-badge ${kda >= 3 ? 'badge-ratio-high' : kda >= 2 ? 'badge-ratio-mid' : 'badge-ratio-low'}">
                                        <i class="bi bi-star-fill me-1"></i>
                                        ${kda}
                                    </span>
                                </div>
                                
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge stats-badge badge-gold">
                                        <i class="bi bi-coin me-1"></i>
                                        ${goldFormatted} é‡‘å¸
                                    </span>
                                    ${game.cs ? `<span class="badge stats-badge badge-cs">
                                        <i class="bi bi-bullseye me-1"></i>
                                        ${game.cs} CS
                                    </span>` : ''}
                                </div>
                            </div>

                            <!-- å³ä¾§ï¼šæ—¶é—´å’Œæ“ä½œ -->
                            <div class="col-md-4 col-meta">
                                <div class="text-end">
                                    <div class="mb-2">
                                        <i class="bi bi-clock me-1 text-muted"></i>
                                        <span class="text-muted">${game.time_ago || ''}</span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="badge bg-light text-dark px-3 py-1">ç¬¬ ${globalIndex} åœº</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill me-2" onclick="toggleMatchDetails(${index})" type="button">
                                            <i class="bi bi-chevron-down me-1"></i>è¯¦æƒ…
                                        </button>
                                        <a class="btn btn-sm btn-outline-secondary rounded-pill" 
                                            href="/match/${encodeURIComponent(summonerName)}/${index}?match_id=${encodeURIComponent(game.match_id || '')}"
                                            target="_blank" rel="noopener noreferrer">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- inline details container (collapsed by default) -->
                        <div id="match-details-${index}" class="match-details mt-3" style="display:none;"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function toggleMatchDetails(index) {
        const detailsId = `match-details-${index}`;
        const el = document.getElementById(detailsId);
        if (!el) return;

        // å¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œç›´æ¥åˆ‡æ¢æ˜¾ç¤º
        if (el.dataset.loaded === 'true') {
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
            return;
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        el.style.display = 'block';
        el.innerHTML = `<div class="text-center py-3"><div class="spinner-border" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div></div>`;

        try {
            const games = window._games || [];
            const gameMeta = games[index];
            let resp;
            if (gameMeta && gameMeta.match_id) {
                resp = await fetch(`/get_match?match_id=${encodeURIComponent(gameMeta.match_id)}`);
            } else {
                resp = await fetch(`/get_match?name=${encodeURIComponent(summonerName)}&index=${index}`);
            }
            const data = await resp.json();
            console.debug('get_match response for index', index, data);
            if (!data.success) {
                el.innerHTML = `<div class="alert alert-warning">æ— æ³•è·å–å¯¹å±€è¯¦æƒ…: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                el.dataset.loaded = 'true';
                return;
            }

            const game = data.game;
            try {
                el.innerHTML = renderInlineMatchDetail(game);
            } catch (renderErr) {
                console.error('renderInlineMatchDetail failed', renderErr, game);
                el.innerHTML = `<div class="alert alert-danger">æ¸²æŸ“å¯¹å±€è¯¦æƒ…å¤±è´¥ï¼ˆæ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ï¼‰</div>`;
            }
            el.dataset.loaded = 'true';
        } catch (e) {
            console.error(e);
            el.innerHTML = `<div class="alert alert-danger">åŠ è½½å¯¹å±€è¯¦æƒ…å¤±è´¥</div>`;
            el.dataset.loaded = 'true';
        }
    }

    // é€šç”¨ç©å®¶ä¿¡æ¯æ¸²æŸ“å‡½æ•°ï¼ˆCHERRY å’Œæ™®é€šæ¨¡å¼å…±ç”¨ï¼‰
    function renderPlayerHtml(p, idx) {
        const name = p.summonerName || (p.player && (p.player.gameName ? (p.player.gameName + (p.player.tagLine ? ('#'+p.player.tagLine) : '')) : p.player.summonerName)) || 'æœªçŸ¥';
        const playerPuuid = p.puuid || (p.player && p.player.puuid) || '';
        const icon = p.profileIcon || (p.player && (p.player.profileIcon)) || p.profileIconId || '';
        // resolve champion image key via CHAMPION_MAP (server-provided)
        const champKey = (p.championId && CHAMPION_MAP && CHAMPION_MAP[p.championId]) ? CHAMPION_MAP[p.championId] : (p.champion || p.championName || '');
        const champImg = champKey ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/champion/${champKey}.png" class="champion-icon me-2" onerror="this.style.display='none'">` : '';
        const level = (p.stats && p.stats.champLevel) || p.champLevel || 0;
        const champWrapper = champImg ? `<div class="champion-wrapper">${champImg}${level?`<span class="level-badge">${level}</span>`:''}</div>` : '';
        const k = p.stats ? p.stats.kills : (p.kills || 0);
        const d = p.stats ? p.stats.deaths : (p.deaths || 0);
        const a = p.stats ? p.stats.assists : (p.assists || 0);
        const gold = (p.stats && p.stats.goldEarned) || p.gold || 0;
        const cs = (p.stats && ((p.stats.totalMinionsKilled||0)+(p.stats.neutralMinionsKilled||0))) || p.cs || 0;
        const damage = (p.stats && (p.stats.totalDamageDealtToChampions || 0)) || p.totalDamageDealtToChampions || 0;
        const heal = (p.stats && p.stats.totalHeal) || p.totalHeal || 0;
        const vision = (p.stats && p.stats.visionScore) || p.visionScore || 0;
        const items = [];
        if (p.stats) {
            for (let i=0;i<7;i++) { const key='item'+i; if (p.stats[key] !== undefined) items.push(p.stats[key]); }
        }
        const itemsHtml = items.map(id => id ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/item/${id}.png" class="item-icon" onerror="this.style.display='none'">` : '').join('');
        
        // æå–å¢å¼ºï¼ˆAugmentsï¼‰- KIWI/CHERRYæ¨¡å¼
        let augmentsHtml = '';
        if (p.stats && p.stats.playerAugment1) {
            const augments = [];
            for (let i = 1; i <= 6; i++) {
                const augId = p.stats['playerAugment' + i];
                const augIconUrl = p.stats['augmentIcon' + i];
                const augName = p.stats['augmentName' + i];
                const augDesc = p.stats['augmentDesc' + i];
                if (augId && augId > 0) {
                    augments.push({ id: augId, iconUrl: augIconUrl, name: augName, desc: augDesc });
                }
            }
            if (augments.length > 0) {
                augmentsHtml = `<div class="augments-row small mt-1">
                    ${augments.map(aug => {
                        // æ„å»ºtooltipå†…å®¹ï¼ˆä¸­æ–‡åç§°+æè¿°ï¼‰
                        let tooltip = aug.name || `æµ·å…‹æ–¯å¤©èµ‹ ${aug.id}`;
                        if (aug.desc) {
                            // æ¸…ç†HTMLæ ‡ç­¾å¹¶æˆªæ–­æè¿°
                            const cleanDesc = aug.desc.replace(/<[^>]+>/g, '').substring(0, 200);
                            tooltip = `${aug.name}\\n${cleanDesc}${cleanDesc.length >= 200 ? '...' : ''}`;
                        }
                        
                        if (aug.iconUrl) {
                            return `<img src="${aug.iconUrl}" 
                                class="augment-icon" 
                                title="${tooltip.replace(/"/g, '&quot;')}" 
                                onerror="this.onerror=null;this.outerHTML='<span class=\\'badge\\' style=\\'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 2px 6px;\\' title=\\'${tooltip.replace(/"/g, '&quot;')}\\'>âš¡${aug.id}</span>';">`;
                        } else {
                            // å¦‚æœæ²¡æœ‰å›¾æ ‡URLï¼Œæ˜¾ç¤ºæ–‡æœ¬å¾½ç« 
                            return `<span class='badge' style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 2px 6px;' title='${tooltip.replace(/"/g, '&quot;')}'>âš¡${aug.id}</span>`;
                        }
                    }).join(' ')}
                </div>`;
            }
        }
        
        const profileImg = icon ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/${icon}.png" class="profile-img" onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/29.png';">` : `<div class="profile-placeholder"></div>`;
        // clickable area uses inline style to look like plain text (no blue/underline)
        const playerLink = `/summoner/${encodeURIComponent(name)}?puuid=${encodeURIComponent(playerPuuid)}`;
        const ratio = d > 0 ? ((k + a) / d) : (k + a);
        const ratioNum = Math.round(ratio * 100) / 100;
        const ratioStr = ratioNum.toFixed(2);
        let kdaClass = 'kda-bad';
        if (ratioNum >= 5) kdaClass = 'kda-good';
        else if (ratioNum >= 3) kdaClass = 'kda-mid';

        return `
            <div class="match-row ${p.win ? 'win-row' : ''}">
                <div class="col-player-info">
                    <a href="${playerLink}" class="player-link" target="_blank">${profileImg}</a>
                    <div>
                        <div class="player-name"><a href="${playerLink}" class="player-link player-name" target="_blank">${name}</a></div>
                        <div class="small-muted">${p.role || ''} ${p.lane || ''}</div>
                        ${augmentsHtml}
                    </div>
                </div>
                <div class="col-champion">${champWrapper}</div>
                <div class="col-kda">
                    <span class="kda-prominent ${kdaClass}">${k}/${d}/${a}</span>
                    <div class="small-muted" style="color: #495057; font-weight: 600;">${ratioStr} KDA</div>
                </div>
                <div class="col-items-wrapper">
                    <div class="items-row">${itemsHtml}</div>
                    <div class="stats-row small-muted">${fmt(gold)}g Â· ${cs} CS Â· ${fmt(damage)} DMG</div>
                </div>
            </div>`;
    }

    // CHERRY æ¨¡å¼æ¸²æŸ“å‡½æ•°
    function renderCherryMode(game, sortedSubteams) {
        // å‰4åä¸ºè·èƒœé˜Ÿä¼
        const winningSubteams = sortedSubteams.filter(t => t.placement <= 4);
        const losingSubteams = sortedSubteams.filter(t => t.placement > 4);
        
        function subteamHtml(subteam) {
            const placement = subteam.placement;
            const isWinning = placement <= 4;
            const rankEmoji = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£'][placement - 1] || `#${placement}`;
            
            return `
                <div class="mb-3 p-2 rounded ${isWinning ? 'bg-light-success' : 'bg-light'}" style="border-left: 4px solid ${isWinning ? '#28a745' : '#6c757d'}">
                    <h6 class="mb-2">
                        <span class="badge ${isWinning ? 'bg-success' : 'bg-secondary'}">${rankEmoji} æ’å ${placement}</span>
                        <span class="badge bg-info ms-2">å­é˜Ÿ ${subteam.subteamId}</span>
                    </h6>
                    ${subteam.players.map((p, i) => renderPlayerHtml(p, i)).join('')}
                </div>
            `;
        }
        
        let headerTimeHtml = '';
        try {
            if (game.gameCreation) {
                const durationSec = game.gameDuration || 0;
                const start = new Date(game.gameCreation);
                const end = new Date(game.gameCreation + (durationSec * 1000));
                const minutes = Math.floor(durationSec / 60);
                const seconds = durationSec % 60;
                headerTimeHtml = `<div class="mb-2 text-muted">
                    <span class="badge bg-primary me-2">æ–—é­‚ç«æŠ€åœº (2v2v2v2)</span>
                    æ—¶é•¿: ${minutes} åˆ† ${seconds} ç§’ â€¢ å¼€å§‹: ${start.toLocaleString()} â€¢ ç»“æŸ: ${end.toLocaleString()}
                </div>`;
            }
        } catch(e) { headerTimeHtml = ''; }
        
        return `
            <div class="card mt-2">
                <div class="card-body">
                    ${headerTimeHtml}
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-success mb-3">
                                <i class="bi bi-trophy-fill me-2"></i>è·èƒœé˜Ÿä¼ (å‰4å)
                            </h5>
                            ${winningSubteams.map(st => subteamHtml(st)).join('')}
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-secondary mb-3">
                                <i class="bi bi-x-circle-fill me-2"></i>å¤±è´¥é˜Ÿä¼ (å4å)
                            </h5>
                            ${losingSubteams.map(st => subteamHtml(st)).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderInlineMatchDetail(game) {
        if (!game) return `<div class="text-muted">æ— å¯¹å±€æ•°æ®</div>`;
        const participants = game.participants || [];
        const gameMode = game.gameMode || '';
        
        // CHERRY æ¨¡å¼ï¼šæŒ‰å­é˜Ÿä¼åˆ†ç»„
        const isCherryMode = gameMode === 'CHERRY';
        
        if (isCherryMode) {
            // æŒ‰å­é˜Ÿä¼åˆ†ç»„
            const subteams = {};
            participants.forEach(p => {
                const subteamId = (p.stats && p.stats.playerSubteamId) || 0;
                if (!subteams[subteamId]) {
                    subteams[subteamId] = {
                        players: [],
                        placement: (p.stats && p.stats.subteamPlacement) || 0
                    };
                }
                subteams[subteamId].players.push(p);
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ’åæ’åº
            const sortedSubteams = Object.entries(subteams)
                .map(([id, data]) => ({ subteamId: id, ...data }))
                .sort((a, b) => a.placement - b.placement);
            
            return renderCherryMode(game, sortedSubteams);
        }
        
        // æ™®é€šæ¨¡å¼ï¼šæŒ‰é˜Ÿä¼åˆ†ç»„
        const teamA = participants.filter(p => p.teamId === 100);
        const teamB = participants.filter(p => p.teamId === 200);
    // determine winning teamId from game.teams if present
        const winningTeamId = (game.teams || []).reduce((winId, t) => {
            // some payloads use 'win': 'Win' or boolean true
            if (t.win === true || String(t.win).toLowerCase() === 'win') return t.teamId || winId;
            return winId;
        }, null);

        // show start/end times and duration above teams
        let headerTimeHtml = '';
        try {
            if (game.gameCreation) {
                const durationSec = game.gameDuration || 0;
                const start = new Date(game.gameCreation);
                const end = new Date(game.gameCreation + (durationSec * 1000));
                const minutes = Math.floor(durationSec / 60);
                const seconds = durationSec % 60;
                headerTimeHtml = `<div class="mb-2 text-muted">æ—¶é•¿: ${minutes} åˆ† ${seconds} ç§’ â€¢ å¼€å§‹: ${start.toLocaleString()} â€¢ ç»“æŸ: ${end.toLocaleString()}</div>`;
            }
        } catch(e) { headerTimeHtml = ''; }
        return `
            <div class="card mt-2">
                <div class="card-body">
                    ${headerTimeHtml}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>é˜Ÿä¼ 1 ${winningTeamId === 100 ? '<span class="badge bg-success ms-2">èƒœåˆ©</span>' : ''}</h6>
                            ${teamA.map((p,i) => renderPlayerHtml(p,i)).join('')}
                        </div>
                        <div class="col-md-6">
                            <h6>é˜Ÿä¼ 2 ${winningTeamId === 200 ? '<span class="badge bg-success ms-2">èƒœåˆ©</span>' : ''}</h6>
                            ${teamB.map((p,i) => renderPlayerHtml(p,i)).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => loadSummonerDetails());
</script>

</body>
</html>
