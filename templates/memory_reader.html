<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内存读取 - LOLHelper</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .status-badge {
            font-size: 1.1rem;
            padding: 8px 20px;
        }
        
        .data-card {
            transition: transform 0.2s;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
        }
        
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        .health-bar {
            background: linear-gradient(90deg, #dc3545 0%, #28a745 100%);
        }
        
        .mana-bar {
            background: linear-gradient(90deg, #007bff 0%, #17a2b8 100%);
        }
        
        .position-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }
        
        .spell-cd {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            border-radius: 10px;
            font-weight: bold;
            margin: 5px;
        }
        
        .spell-ready {
            background: #28a745;
            color: white;
        }
        
        .spell-cooldown {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>

<a href="/" class="btn btn-primary back-button">
    <i class="bi bi-arrow-left"></i> 返回主页
</a>

<div class="main-container">
    <!-- 标题和连接控制 -->
    <div class="text-center mb-4">
        <h1 class="text-white mb-3">
            <i class="bi bi-memory"></i> 游戏内存读取
        </h1>
        <div id="status-container">
            <span class="badge status-badge bg-secondary" id="status-badge">
                <i class="bi bi-circle-fill"></i> 未连接
            </span>
        </div>
        <div class="mt-3">
            <button class="btn btn-success btn-lg" id="connect-btn" onclick="connectToGame()">
                <i class="bi bi-plug"></i> 连接游戏
            </button>
            <button class="btn btn-danger btn-lg" id="disconnect-btn" onclick="disconnectGame()" style="display: none;">
                <i class="bi bi-x-circle"></i> 断开连接
            </button>
        </div>
    </div>

    <!-- 警告信息 -->
    <div class="alert alert-warning" role="alert" id="warning-alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>注意：</strong>
        <ul class="mb-0 mt-2">
            <li>需要安装 <code>pymem</code> 库: <code>pip install pymem</code></li>
            <li><strong class="text-danger">必须以管理员权限运行程序！</strong></li>
            <li><strong class="text-danger">必须在游戏对局中才能连接！</strong></li>
            <li>建议进入训练模式或人机对局进行测试</li>
            <li>游戏更新后，内存地址可能需要重新配置</li>
            <li>仅供学习研究使用</li>
        </ul>
    </div>

    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle-fill"></i>
        <strong>使用步骤：</strong>
        <ol class="mb-0 mt-2">
            <li>以管理员权限启动本程序</li>
            <li>启动LOL游戏并进入对局（训练模式/人机/匹配）</li>
            <li>等待游戏完全加载（能看到游戏画面）</li>
            <li>点击下方"连接游戏"按钮</li>
        </ol>
    </div>

    <!-- 消息提示区域 -->
    <div id="alert-container" style="position: fixed; top: 80px; right: 20px; z-index: 9999; max-width: 500px;"></div>

    <!-- 数据显示区域 -->
    <div id="data-container" style="display: none;">
        <div class="row">
            <!-- 玩家状态 -->
            <div class="col-lg-6 mb-4">
                <div class="card data-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-fill"></i> 玩家状态</h5>
                    </div>
                    <div class="card-body">
                        <!-- 生命值 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="bi bi-heart-fill text-danger"></i> 生命值</span>
                                <span id="health-text">0 / 0 (0%)</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar health-bar" id="health-bar" role="progressbar" 
                                     style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>

                        <!-- 法力值 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="bi bi-droplet-fill text-primary"></i> 法力值</span>
                                <span id="mana-text">0 / 0 (0%)</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar mana-bar" id="mana-bar" role="progressbar" 
                                     style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>

                        <!-- 其他信息 -->
                        <div class="row text-center mt-4">
                            <div class="col-4">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-muted mb-1">等级</h6>
                                    <h3 class="mb-0" id="level-text">0</h3>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-muted mb-1">金币</h6>
                                    <h3 class="mb-0" id="gold-text">0</h3>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-muted mb-1">队伍</h6>
                                    <h3 class="mb-0" id="team-text">-</h3>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 text-center">
                            <span class="badge bg-success" id="alive-badge">存活</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 位置和时间 -->
            <div class="col-lg-6 mb-4">
                <div class="card data-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-geo-alt-fill"></i> 位置与时间</h5>
                    </div>
                    <div class="card-body">
                        <!-- 游戏时间 -->
                        <div class="text-center mb-4">
                            <h6 class="text-muted">游戏时间</h6>
                            <h1 class="display-4 mb-0" id="game-time">00:00</h1>
                        </div>

                        <!-- 坐标 -->
                        <div class="position-display text-center">
                            <div class="mb-2"><strong>X:</strong> <span id="pos-x">0.00</span></div>
                            <div class="mb-2"><strong>Y:</strong> <span id="pos-y">0.00</span></div>
                            <div><strong>Z:</strong> <span id="pos-z">0.00</span></div>
                        </div>

                        <!-- 小地图预览 (可选) -->
                        <div class="mt-4 text-center">
                            <canvas id="minimap" width="300" height="300" 
                                    style="border: 2px solid #dee2e6; border-radius: 10px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 技能冷却 -->
        <div class="row">
            <div class="col-12">
                <div class="card data-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill"></i> 技能冷却</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="spell-container">
                            <div class="spell-cd spell-ready" id="spell-q">Q<br>Ready</div>
                            <div class="spell-cd spell-ready" id="spell-w">W<br>Ready</div>
                            <div class="spell-cd spell-ready" id="spell-e">E<br>Ready</div>
                            <div class="spell-cd spell-ready" id="spell-r">R<br>Ready</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let updateInterval = null;

    // 显示提示消息
    function showAlert(type, message) {
        const container = document.getElementById('alert-container');
        const alertId = 'alert-' + Date.now();
        
        const alertHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        container.innerHTML = alertHTML;
        
        // 自动关闭（除非是错误信息）
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
    }

    // 连接游戏
    async function connectToGame() {
        try {
            const response = await fetch('/memory/connect', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                updateStatus(true);
                showDataContainer();
                startAutoUpdate();
                showAlert('success', result.message || '✅ 连接成功！');
            } else {
                if (result.error_code === 'NO_ADMIN') {
                    showAlert('danger', 
                        `<strong>❌ 需要管理员权限！</strong><br><br>` +
                        `<strong>解决步骤：</strong><br>` +
                        `1. 关闭此程序<br>` +
                        `2. 找到 app.py 或 LOLHelper.exe<br>` +
                        `3. 右键点击 → <strong>以管理员身份运行</strong><br>` +
                        `4. 重新访问此页面并连接<br><br>` +
                        `<small>提示：读取游戏内存需要管理员权限</small>`
                    );
                } else {
                    showAlert('warning', result.message || '❌ 连接失败');
                }
            }
        } catch (error) {
            console.error('连接失败:', error);
            showAlert('danger', '❌ 连接失败: ' + error.message);
        }
    }

    // 断开连接
    async function disconnectGame() {
        try {
            const response = await fetch('/memory/disconnect', { method: 'POST' });
            const result = await response.json();

            updateStatus(false);
            hideDataContainer();
            stopAutoUpdate();
            alert('✅ ' + result.message);
        } catch (error) {
            console.error('断开失败:', error);
        }
    }

    // 更新状态显示
    function updateStatus(connected) {
        const badge = document.getElementById('status-badge');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');

        if (connected) {
            badge.className = 'badge status-badge bg-success';
            badge.innerHTML = '<i class="bi bi-circle-fill"></i> 已连接';
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = 'inline-block';
        } else {
            badge.className = 'badge status-badge bg-secondary';
            badge.innerHTML = '<i class="bi bi-circle-fill"></i> 未连接';
            connectBtn.style.display = 'inline-block';
            disconnectBtn.style.display = 'none';
        }
    }

    // 显示/隐藏数据容器
    function showDataContainer() {
        document.getElementById('data-container').style.display = 'block';
    }

    function hideDataContainer() {
        document.getElementById('data-container').style.display = 'none';
    }

    // 开始自动更新
    function startAutoUpdate() {
        if (updateInterval) return;
        
        updateInterval = setInterval(async () => {
            await updateGameData();
        }, 500); // 每0.5秒更新一次
    }

    // 停止自动更新
    function stopAutoUpdate() {
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
        }
    }

    // 更新游戏数据
    async function updateGameData() {
        try {
            const response = await fetch('/memory/player_data');
            const result = await response.json();

            if (result.success && result.data) {
                updatePlayerData(result.data.local_player);
                updateGameTime(result.data.game_time);
            }
        } catch (error) {
            console.error('更新数据失败:', error);
        }
    }

    // 更新玩家数据显示
    function updatePlayerData(data) {
        if (!data || !data.health) return;

        // 生命值
        const healthPercent = data.health.percent || 0;
        document.getElementById('health-text').textContent = 
            `${Math.round(data.health.current)} / ${Math.round(data.health.max)} (${healthPercent.toFixed(1)}%)`;
        document.getElementById('health-bar').style.width = healthPercent + '%';

        // 法力值
        const manaPercent = data.mana.percent || 0;
        document.getElementById('mana-text').textContent = 
            `${Math.round(data.mana.current)} / ${Math.round(data.mana.max)} (${manaPercent.toFixed(1)}%)`;
        document.getElementById('mana-bar').style.width = manaPercent + '%';

        // 其他信息
        document.getElementById('level-text').textContent = data.level || 0;
        document.getElementById('gold-text').textContent = Math.round(data.gold || 0);
        
        // 队伍
        const teamText = data.team === 100 ? '蓝色方' : data.team === 200 ? '红色方' : '未知';
        document.getElementById('team-text').textContent = teamText;

        // 存活状态
        const aliveBadge = document.getElementById('alive-badge');
        if (data.is_alive) {
            aliveBadge.className = 'badge bg-success';
            aliveBadge.textContent = '存活';
        } else {
            aliveBadge.className = 'badge bg-danger';
            aliveBadge.textContent = '阵亡';
        }

        // 位置
        if (data.position) {
            document.getElementById('pos-x').textContent = data.position.x.toFixed(2);
            document.getElementById('pos-y').textContent = data.position.y.toFixed(2);
            document.getElementById('pos-z').textContent = data.position.z.toFixed(2);
            
            // 更新小地图
            updateMinimap(data.position.x, data.position.z);
        }
    }

    // 更新游戏时间
    function updateGameTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        document.getElementById('game-time').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // 更新小地图
    function updateMinimap(x, z) {
        const canvas = document.getElementById('minimap');
        const ctx = canvas.getContext('2d');
        
        // 清空画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 绘制边框
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, canvas.width, canvas.height);
        
        // 地图范围 (召唤师峡谷大约是 -15000 到 15000)
        const mapSize = 30000;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        
        // 转换坐标
        const pixelX = centerX + (x / mapSize) * canvas.width;
        const pixelY = centerY - (z / mapSize) * canvas.height;
        
        // 绘制玩家位置
        ctx.fillStyle = '#28a745';
        ctx.beginPath();
        ctx.arc(pixelX, pixelY, 8, 0, Math.PI * 2);
        ctx.fill();
        
        // 绘制中心点
        ctx.fillStyle = '#dc3545';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
        ctx.fill();
    }

    // 页面加载时检查状态
    window.addEventListener('load', async () => {
        try {
            const response = await fetch('/memory/status');
            const result = await response.json();

            if (result.available && result.connected) {
                updateStatus(true);
                showDataContainer();
                startAutoUpdate();
            }
        } catch (error) {
            console.error('检查状态失败:', error);
        }
    });

    // 页面卸载时断开连接
    window.addEventListener('beforeunload', () => {
        if (updateInterval) {
            stopAutoUpdate();
        }
    });
</script>

</body>
</html>
