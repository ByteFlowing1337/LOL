# LO## 🐛 v2.1.1 - 修复线程安全问题 (2025-10-02)

### Bug修复
- **修复截图线程安全问题**: 修改mss实例创建方式，使用上下文管理器避免多线程冲突
  - 错误: `'_thread._local' object has no attribute 'srcdc'`
  - 解决: 在`capture_screen()`中每次创建新的mss实例
  - 影响: 后台检测和手动截图现在完全稳定
- 详细说明: 参见 `BUGFIX_LOG.md`

---

## 🎥 v2.1.0 - CV视觉检测功能 (2025-10-02)

### 🚀 重大更新：YOLO计算机视觉检测lper 功能更新日志

---

## 🎥 v2.1.0 - CV视觉检测功能 (2025-10-02)

### � 重大更新：YOLO计算机视觉检测

#### 核心功能

##### 1. 实时游戏画面检测系统
- **英雄抬手/施法检测** 🏹
  - 实时识别英雄的施法动作
  - 提前0.2-0.5秒预警技能释放
  - 支持自定义置信度阈值
  
- **小地图敌人检测** 🗺️
  - 自动监控小地图区域
  - 识别敌方英雄位置
  - 高优先级警报提示

- **危险信号检测** ⚠️
  - 检测低血量状态
  - 识别危险信号标记
  - 综合危险等级评估

- **技能指示器检测** ⚡
  - 识别技能指示器
  - 检测技能施放方向
  - 辅助走位躲避

##### 2. 交互式检测控制面板
- 开始/停止检测按钮
- 实时状态显示
- 手动截图功能（带检测标注）
- 检测统计数据

##### 3. 可视化检测结果
- 4个独立检测面板实时更新
- 彩色编码分类显示
- 检测置信度显示

##### 4. 智能警报系统
- 3级警报严重程度（低/中/高）
- 自动弹出通知带动画
- 5秒自动消失

##### 5. 检测日志
- 时间戳记录
- 完整检测历史
- 最近50条记录展示

#### 新增文件
- `services/game_vision.py` - YOLO检测引擎（320行）
- `services/vision_service.py` - 后台检测服务（115行）
- `templates/vision_detection.html` - CV检测仪表盘（350行）
- `websocket/socket_events.py` - 添加CV事件处理器
- `routes/api_routes.py` - 添加 `/vision_detection` 路由
- `CV_DETECTION_GUIDE.md` - 完整使用指南
- `install_cv_deps.ps1` - 一键安装脚本
- `test_cv_detection.py` - 功能测试脚本

#### 技术架构
```
游戏画面 → MSS截图 → YOLO推理 → 结果处理 → Socket.IO → 前端可视化
```

#### 新增依赖
- opencv-python >= 4.8.0
- numpy >= 1.24.0
- mss >= 9.0.0
- ultralytics >= 8.0.0

#### 使用说明
1. 运行：`.\install_cv_deps.ps1` 安装依赖
2. 启动：`python app_new.py`
3. 访问：http://localhost:5000/vision_detection
4. 点击"开始检测"按钮

详细文档：`CV_DETECTION_GUIDE.md`

---

## 📊 v2.0.0 - 增强版数据展示 (2025-10-01)

### ✨ 新增功能

### 1. **实时游戏详细信息展示**
- **功能描述**: 利用游戏API (`https://127.0.0.1:2999`) 获取完整游戏数据
- **展示内容**:
  - ✅ 玩家等级 (Level)
  - ✅ KDA 详细信息 (击杀/死亡/助攻)
  - ✅ 补刀数 (CS)
  - ✅ 装备列表（带图标）
  - ✅ 符文配置（主系、副系、基石）
  - ✅ 召唤师技能
  - ✅ 队伍归属（ORDER / CHAOS）
  - ✅ 位置信息
  - ✅ 死亡状态和复活倒计时
  - ✅ 游戏时间、模式、地图信息
  - ✅ 最近击杀事件

### 2. **召唤师详细战绩页面**
- **功能描述**: 点击召唤师昵称后跳转到独立页面查看详细历史战绩
- **页面地址**: `/summoner/<召唤师名称#TAG>`
- **展示内容**:
  - 📊 战绩统计摘要（总场次、胜率、平均KDA、最常使用英雄）
  - 📝 最近20场详细战绩
  - 🎮 每场比赛的英雄、KDA、金币、补刀、时间等信息
  - 🎨 胜利/失败渐变背景效果
  - 🖱️ 卡片悬停动画

### 3. **实时游戏监控页面**
- **功能描述**: 独立页面实时监控当前游戏状态
- **页面地址**: `/live_game`
- **功能特性**:
  - 🔄 每2秒自动刷新游戏数据
  - 👥 队伍分组显示（ORDER vs CHAOS）
  - 🎯 高亮显示当前玩家
  - 💀 标识死亡玩家和复活倒计时
  - 🔗 可点击召唤师名称跳转详细战绩
  - 📦 显示装备图标
  - ⏱️ 实时游戏计时器
  - ⚡ 最近击杀事件记录

### 4. **交互增强**
- **点击跳转**: 主页面中队友/敌人名称可点击跳转到详细战绩页面
- **悬停提示**: 鼠标悬停时显示"点击查看详细战绩"
- **新窗口打开**: 实时游戏详情在新标签页打开

## 📁 新增文件

### 1. 模板文件 (templates/)
```
templates/
├── summoner_detail.html      # 召唤师详细战绩页面
└── live_game.html             # 实时游戏监控页面
```

### 2. 工具模块 (utils/)
```
utils/
└── game_data_formatter.py     # 游戏数据格式化工具
```

## 🔧 修改文件

### 1. routes/api_routes.py
**新增路由**:
- `GET /summoner/<summoner_name>` - 渲染召唤师详细战绩页面
- `GET /live_game` - 渲染实时游戏监控页面
- `GET /get_live_game_data` - 获取实时游戏数据API

**增强功能**:
- `_process_match_history()` - 增加金币、CS、时间、游戏模式等字段
- `_format_game_mode()` - 游戏模式中文化
- `_calculate_time_ago()` - 时间差计算

### 2. static/js/main.js
**修改内容**:
- 队友/敌人名称改为超链接（可点击跳转）
- 增加 `title` 属性显示悬停提示

### 3. templates/index.html
**新增按钮**:
- "查看实时游戏详情" 按钮（跳转到 `/live_game`）

## 📊 数据结构示例

### 格式化后的玩家数据
```python
{
    'summonerName': '召唤师2321#55777',
    'gameName': '召唤师2321',
    'tagLine': '55777',
    'champion': '远古巫灵',
    'level': 4,
    'isDead': False,
    'respawnTimer': 0,
    'kills': 2,
    'deaths': 1,
    'assists': 0,
    'cs': 10,
    'kda': '2/1/0',
    'items': [
        {'id': 1056, 'name': '多兰之戒', 'count': 1},
        {'id': 1082, 'name': '黑暗封印', 'count': 1}
    ],
    'keystone': '奥术彗星',
    'primaryRune': '巫术',
    'secondaryRune': '主宰',
    'spell1': '幽灵疾步',
    'spell2': '闪现',
    'team': 'CHAOS',
    'position': 'NONE',
    'isCurrentPlayer': True
}
```

## 🎨 UI/UX 改进

### 召唤师详细战绩页面
- ✨ 渐变背景（胜利=绿色，失败=红色）
- 🎯 悬停卡片上浮效果
- 📈 统计摘要卡片（4个指标）
- 🖼️ 英雄圆形头像
- 🎨 根据胜率和KDA显示不同颜色徽章

### 实时游戏监控页面
- 🎮 大号游戏计时器（绿色加粗）
- 🔵 ORDER队蓝色边框
- 🔴 CHAOS队红色边框
- ⚠️ 死亡玩家半透明红色背景
- 🌟 当前玩家黄色高亮背景
- 📦 装备图标网格布局
- 🔄 自动刷新指示器

## 🚀 使用方式

### 1. 启动应用
```bash
python app_new.py
# 或
python app.py
```

### 2. 访问页面
- **主页**: http://localhost:5000/
- **实时游戏详情**: http://localhost:5000/live_game
- **召唤师详细战绩**: http://localhost:5000/summoner/召唤师名称%23TAG

### 3. 操作流程
1. 点击"敌我分析"按钮
2. 进入游戏后，队友/敌人名称变为可点击链接
3. 点击任意召唤师名称，跳转到详细战绩页面
4. 或点击"查看实时游戏详情"按钮，打开实时监控页面

## 🔍 技术细节

### API端点
1. **LCU API** (动态端口): 获取召唤师信息、战绩数据
2. **游戏API** (端口2999): 获取实时游戏数据

### 数据流
```
游戏客户端 (2999端口)
    ↓
format_game_data() 格式化
    ↓
/get_live_game_data API
    ↓
JavaScript 渲染
    ↓
实时游戏页面展示
```

### 自动刷新机制
```javascript
// 每2秒自动刷新
setInterval(loadGameData, 2000);
```

## 🐛 已知问题和解决方案

### 问题1: 图标加载失败
**原因**: 英雄名称格式不匹配  
**解决**: 使用 `onerror` 回退到默认图标
```javascript
onerror="this.src='https://ddragon.leagueoflegends.com/cdn/14.13.1/img/profileicon/29.png'"
```

### 问题2: 游戏未开始时访问实时页面
**原因**: 游戏API不可用  
**解决**: 显示友好错误提示"未在游戏中"

## 📚 依赖库
- Flask 5.x
- Flask-SocketIO
- requests
- Bootstrap 5.3.3
- Bootstrap Icons 1.11.3

## 🎯 下一步计划
- [ ] 添加英雄胜率统计
- [ ] 支持多个赛季数据对比
- [ ] 实时伤害统计图表
- [ ] 保存分析结果到本地
- [ ] 支持自定义刷新频率
- [ ] 添加语音提示功能

## 📝 更新日志
- 2025-10-02: 完成实时游戏详情页面和召唤师详细战绩功能
- 2025-10-02: 添加点击跳转功能
- 2025-10-02: 优化数据格式化和UI展示

---

**作者**: LOLHelper Team  
**版本**: v2.0.0  
**更新时间**: 2025-10-02
