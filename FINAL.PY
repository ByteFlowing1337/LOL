import requests
from requests.auth import HTTPBasicAuth
import urllib3
import json

# ç¦ç”¨SSLè­¦å‘Š
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_puuid(auth_token, app_port, summoner_name):
    """è·å–å¬å”¤å¸ˆçš„PUUID"""
    url = f"https://riot:{auth_token}@127.0.0.1:{app_port}/lol-summoner/v1/summoners"
    try:
        response = requests.get(
            url,
            params={'name': summoner_name},
            auth=HTTPBasicAuth('riot', auth_token),
            verify=False,
            timeout=10
        )
        
        if response.status_code == 200:
            data = response.json()
            return data.get('puuid')
        else:
            print(f"è·å–PUUIDå¤±è´¥! çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”å†…å®¹: {response.text}")
            return None
            
    except requests.exceptions.RequestException as e:
        print(f"è¯·æ±‚å¼‚å¸¸: {e}")
        return None

def get_match_history(auth_token, app_port, puuid):
    """è·å–æ¯”èµ›å†å²è®°å½•"""
    url = f"https://riot:{auth_token}@127.0.0.1:{app_port}/lol-match-history/v1/products/lol/{puuid}/matches"
    try:
        response = requests.get(
            url,
            auth=HTTPBasicAuth('riot', auth_token),
            verify=False,
            timeout=10
        )
        
        if response.status_code == 200:
            return response.json()
        else:
            print(f"è·å–æ¯”èµ›è®°å½•å¤±è´¥! çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”å†…å®¹: {response.text}")
            return None
            
    except requests.exceptions.RequestException as e:
        print(f"è¯·æ±‚å¼‚å¸¸: {e}")
        return None

def main():
    # ç”¨æˆ·è¾“å…¥
    print("="*50)
    print("è‹±é›„è”ç›Ÿæ¯”èµ›è®°å½•è·å–å·¥å…·")
    print("="*50)
    auth_token = input("è¯·è¾“å…¥è®¤è¯ä»¤ç‰Œ(auth_token): ").strip()
    app_port = input("è¯·è¾“å…¥åº”ç”¨ç«¯å£å·(app_port): ").strip()
    summoner_name = input("è¯·è¾“å…¥å¬å”¤å¸ˆåç§°: ").strip()
    
    # è·å–PUUID
    print("\næ­£åœ¨è·å–PUUID...")
    puuid = get_puuid(auth_token, app_port, summoner_name)
    
    if not puuid:
        print("âŒ æ— æ³•è·å–PUUIDï¼Œè¯·æ£€æŸ¥è¾“å…¥å¹¶é‡è¯•")
        return
    
    print(f"âœ… æˆåŠŸè·å–PUUID: {puuid}")
    
    # è·å–æ¯”èµ›è®°å½•
    print("\næ­£åœ¨è·å–æ¯”èµ›è®°å½•...")
    match_history = get_match_history(auth_token, app_port, puuid)
    
    if match_history:
        print("\nğŸ® æ¯”èµ›è®°å½•è·å–æˆåŠŸ!")
        print("="*50)
        
        # ç¾åŒ–è¾“å‡ºæ¯”èµ›è®°å½•
        print(f"æ€»æ¯”èµ›åœºæ¬¡: {match_history.get('totalCount', 0)}")
        print("æœ€è¿‘5åœºæ¯”èµ›:")
        
        # æå–æœ€è¿‘çš„5åœºæ¯”èµ›
        games = match_history.get('games', {}).get('games', [])[:5]
        for i, game in enumerate(games, 1):
            print(f"\næ¯”èµ› #{i}:")
            print(f"æ¨¡å¼: {game.get('gameMode', 'æœªçŸ¥æ¨¡å¼')}")
            print(f"ç±»å‹: {game.get('gameType', 'æœªçŸ¥ç±»å‹')}")
            print(f"å¼€å§‹æ—¶é—´: {game.get('gameCreationDate', 'æœªçŸ¥æ—¶é—´')}")
            print(f"æŒç»­æ—¶é—´: {game.get('gameDuration', 0) // 60}åˆ†{game.get('gameDuration', 0) % 60}ç§’")
            # æŸ¥æ‰¾ç©å®¶æ•°æ®
            for participant in game.get('participants', []):
            #    if participant.get('puuid') == puuid:
                    stats = participant.get('stats', {})
                    print(f"è‹±é›„ID: {participant.get('championId')}")
                    print(f"å‡»æ€/æ­»äº¡/åŠ©æ”»: {stats.get('kills', 0)}/{stats.get('deaths', 0)}/{stats.get('assists', 0)}")
                    print(f"æ˜¯å¦èƒœåˆ©: {'èƒœåˆ©' if stats.get('win', False) else 'å¤±è´¥'}")
                    break
        print("\nå®Œæ•´æ•°æ®å·²ä¿å­˜åˆ° match_history.json")
        
        # ä¿å­˜å®Œæ•´æ•°æ®åˆ°æ–‡ä»¶
        with open('match_history.json', 'w', encoding='utf-8') as f:
            json.dump(match_history, f, ensure_ascii=False, indent=2)
    else:
        print("âŒ æ— æ³•è·å–æ¯”èµ›è®°å½•")

if __name__ == "__main__":
    main()